# For tips how to configure this workflow, see https://github.com/anthropics/claude-code-action.
# Examples: https://github.com/anthropics/claude-code-action/blob/0cf5eeec4f908121edd03a81411b55485994f8d3/docs/solutions.md.

name: Claude PR Review
on:
    # _target gives forks access to upstream's secrets.
    pull_request_target:
        types: [opened, synchronize]
        branches: [main]
jobs:
    review:
        runs-on: ubuntu-latest
        permissions:
            id-token: write # authentication for Claude GH bot
            pull-requests: write # make comments on PR
            contents: read # clone repo
            actions: read # see GH Actions outputs
            issues: read # read issues (for context)
        steps:
            # With _target mode, actions/checkout is checking out upstream, not the current PR.
            # This is fine, we don't want anyone to be able to inject custom CLAUDE.md.
            - name: Checkout upstream repository
              uses: actions/checkout@v6

            - uses: anthropics/claude-code-action@v1
              if: github.event.pull_request.draft == false
              with:
                  # Anthropic auth
                  # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  github_token: ${{ secrets.GITHUB_TOKEN }}

                  # Prompt
                  prompt: |
                      REPO: ${{ github.repository }}
                      PR NUMBER: ${{ github.event.pull_request.number }}

                      Please review this pull request. Use instructions in /review-pr command. However, the patch will be
                      built and tested by other GitHub Actions workflows, so you should skip these parts of that command.

                      You can use multiple subagents to parallelize tasks. Each subagent should be told the PR title and description.

                      Use `gh pr diff ${{ github.event.pull_request.number }} --patch` to access the PR content.
                      Use `gh api --paginate repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments` to list top-level comments.
                      Use `gh api --paginate repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments` to list inline review comments.
                      Use `gh api --paginate repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews | jq '.[] | select(.body != "" and .body != null)'` to list top-level review comments.
                      You are in repository without that patch applied. Do not apply it.

                      For every issue, rate how significant it is. Make sure you are confident in your diagnosis.

                      For every CLAUDE.md compliance violation, check if repo has other places where this issue appears.
                      If it does, do not point out the violation in the place it appears.
                      Instead in the final top-level comment, include a suggestion how to improve CLAUDE.md.

                      Provide detailed feedback as PR comments, using inline comments for specific issues.
                      Use `gh pr comment ${{ github.event.pull_request.number }} --body "..."` for top-level summary. Keep it very short.
                      Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.
                      Prefix all your GitHub comments with "Claude: ".
                      Use the API comment endpoints above to make sure you don't comment about the same issue twice (check both top-level and inline).

                      When linking to code in inline comments, follow the following format precisely, otherwise the Markdown preview
                      won't render correctly: https://github.com/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/README.md#L10-L15
                  claude_args: |
                      --max-turns 50
                      --model claude-opus-4-6
                      --allowedTools "
                        Read,Write,Edit,MultiEdit,LS,Grep,Glob,
                        Bash(cat:*),Bash(test:*),Bash(printf:*),Bash(jq:*),Bash(head:*),Bash(git:*),Bash(gh:*),
                        mcp__github_inline_comment__create_inline_comment,
                        "

                  # Run even when triggered by 3rd party developer's PR
                  allowed_non_write_users: "*"

                  # This requires "tag mode", which is currently bugged:
                  # https://github.com/anthropics/claude-code-action/issues/939
                  track_progress: false

                  # Enable access to other GH Actions outputs
                  additional_permissions: |
                      actions: read
